---
title: "Algorithm to strata"
author: "Suvi Ahtinen"
date: "2025-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven)
library(data.table)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lmeSplines)
library(lubridate)
library(rstatix)
library(aod)
library(NbClust)
library(cluster)
library(clusterCrit)

#import datasets:


energy_adjusted_without_mean_data<-read.table("raw_data_adjusted.csv")
energy_adjusted_mean_data<-read.table("data_adjusted.csv")


```
The fields in "energy_adjusted_without_mean_data" dataset include:

@param "id" Every participants id-number
@param "weeknum" Numbers of weeks (1-52)
@param "year" Numbers of year (2019-2021)
@param "energy_MJ" Purchases' energy at megajoule (MJ)
@param "fixed_euros_no_tobacco_uncat" Inflation fixed euros without tobacco-products
@param "strata_SES" Numbers of strata (1-114)
@param "sample_weights" Weights of strata based on each stratum sample.


The fields in "energy_adjusted_mean_data" dataset include:

@param "weeknum" Numbers of weeks (1-52)
@param "year" Numbers of year (2019-2021)
@param "energy_for_euro" Purchases' energy divided by inflation fixed euros (MJ/euro)
@param "elapsed_time" Elapsed time variable (the trend term) by weeks, started from the first week of March 2019, ended to the second week of May 2021 (1-113)
@param "interrupted01" Binary interrupted variable (0= weeks before the pandemic, 1= weeks after the pandemic)
@param "weeks_after_preCOVID" Weeks after the pandemic (the slope term after the interruption point), started from the second week of March 2020 (55-113)
@param "strata_SES" Numbers of the strata (1-114)
@param "sample_sizes" Sample sizes for every strata  


```{r echo=FALSE, eval=TRUE}

set.seed(123)

#Numbers of strata
strata_num<-length(levels(energy_adjusted_mean_data$strata_SES))

#Spline models to 114 strata:

energy_adjusted_mean_data$Zt0 <- smspline(~ elapsed_time, data=energy_adjusted_mean_data) #smoothing splines

fit_strata_SES_energy<- lme(energy_for_euro ~ elapsed_time + interrupted01 + weeks_after_preCOVID + elapsed_time:strata_SES + interrupted01:strata_SES + weeks_after_preCOVID:strata_SES, data=energy_adjusted_mean_data,
random=list(~1|strata_SES,strata_SES=pdIdent(~Zt0)))


fit_strata_SES_energy_nosmooth<- lme(energy_for_euro ~ elapsed_time + interrupted01 + weeks_after_preCOVID + elapsed_time:strata_SES + interrupted01:strata_SES + weeks_after_preCOVID:strata_SES , data=energy_adjusted_mean_data,
random=list(~1|strata_SES,strata_SES=pdIdent(~elapsed_time)))


energy_adjusted_mean_data$Date<- as.Date(paste0(energy_adjusted_mean_data$year, "-", energy_adjusted_mean_data$weeknum, "-", 7), format = "%Y-%U-%u")

#Figure:

ggplot(energy_adjusted_mean_data,aes(x=Date,y=energy_for_euro,colour=strata_SES)) + geom_line(aes(y = fitted(fit_strata_SES_energy))) + labs(y="Weekly means of energy per used euros (MJ/e)",x="Time (month/year)",colour="Strata") + theme_bw() + scale_x_date(limits=c(as.Date("2019-03-03"),as.Date("2021-05-07")),date_labels = "%m/%Y",date_breaks="3 months") + geom_vline(xintercept=as.Date("2020-03-16"),linetype="dashed") 
#dev.off()

source("cluster_ind_calc_average.R")
new_segs<-cluster_ind_calc_average(elapsed_time=energy_adjusted_mean_data$elapsed_time,strata=energy_adjusted_mean_data$strata_SES,fit_model=fitted(fit_strata_SES_energy),strata_num=strata_num, samples=energy_adjusted_mean_data$sample_sizes)

new_segs

#Generate new data to 5 new strata:

source("data_new_strata.R")

new_strata_data<-data_new_strata(new_strata=new_segs,data=energy_adjusted_without_mean_data, strata_number=5)


new_strata_data$Zt0 <- smspline(~ elapsed_time, data=new_strata_data) #smoothing splines

#Spline model:

fit_new_strata_SES_energy<- lme(energy_for_euro~ elapsed_time + interrupted01 + weeks_after_preCOVID+ elapsed_time:new_strata_SES+ interrupted01:new_strata_SES + weeks_after_preCOVID:new_strata_SES, data=new_strata_data,
random=list(~1|new_strata_SES,new_strata_SES=pdIdent(~Zt0)))

#Figure:

new_strata_data$Date<- as.Date(paste0(new_strata_data$year, "-", new_strata_data$weeknum, "-", 7), format = "%Y-%U-%u")

ggplot(new_strata_data,aes(x=Date,y=MJ_per_euros,colour=new_strata_SES)) + geom_point() + geom_line(aes(y = fitted(fit_new_strata_SES_energy))) + labs(y="Energy-for-euro (MJ/â‚¬)",x="Time (month/year)",colour="Algorithmically combinated strata") + theme_bw() + scale_x_date(limits=c(as.Date("2019-03-03"),as.Date("2021-05-07")),date_labels = "%m/%Y",date_breaks="3 months",date_minor_breaks = "1 week") + scale_colour_manual(values=cbbPalette) + geom_vline(xintercept=as.Date("2020-03-16"),linetype="dashed") 



```